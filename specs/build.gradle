
plugins {
    id 'groovy'
    id 'java'
    id 'idea'
    id "io.qameta.allure" version "2.5"
}


ext {
    allureVersion = '2.7.0'
    testNgVersion = '6.14.3'
    restAssuredVersion = '3.1.0'

}


allure {
    version = "$allureVersion"
    autoconfigure = true
    aspectjweaver = true
    aspectjVersion = '1.8.10'
    resultsDir = file("${rootDir}/build/allure-results")
    reportDir = file("${rootDir}/build/reports/allure-report")
    useTestNG {
        version = "${allureVersion}"
    }
    downloadLink = "https://github.com/allure-framework/allure2/releases/download/$allureVersion/allure-${allureVersion}.zip"
}


version = "1.0"
description = "EC-OpenShift Specs"

sourceCompatibility = 1.8

defaultTasks 'test'

repositories {
    jcenter()
    mavenCentral()
    maven {
        url 'https://oss.sonatype.org/content/repositories/snapshots'
    }
    maven {
        url  "https://dl.bintray.com/ecpluginsdev/maven"
    }

}

dependencies {
    compile 'org.codehaus.groovy:groovy-all:2.4.5:indy'
    compile group: 'org.codehaus.groovy.modules.http-builder', name: 'http-builder', version: '0.7.1'
    compile "org.testng:testng:$testNgVersion"
    // Allure
    compile "io.qameta.allure:allure-testng:$allureVersion"
    // Logger
    compile group: 'log4j', name: 'log4j', version: '1.2.17'
    //compile group: 'org.slf4j', name: 'slf4j-api', version: '1.7.25'
    compile group: 'org.slf4j', name: 'slf4j-simple', version: '1.7.25'
    // JSON
    compile group: 'com.googlecode.json-simple', name: 'json-simple', version: '1.1.1'
    compile group: 'org.json', name: 'json', version: '20180130'
    // OpenShift Api
    compile group: 'io.fabric8', name: 'openshift-client', version: '3.1.12'  // https://github.com/fabric8io/kubernetes-client
    compile group: 'com.openshift', name: 'openshift-java-client', version: '2.7.0.Final' // http://openshift.github.io/openshift-java-client/samplecode/
    compile group: 'com.openshift', name: 'openshift-restclient-java', version: '6.1.0.Final' // https://github.com/openshift/openshift-restclient-java
    // Helper Libraries
    compile group: 'org.awaitility', name: 'awaitility-groovy', version: '3.1.0'
    // Rest-Assured
    compile "io.rest-assured:rest-assured:$restAssuredVersion"
    compile group: 'io.rest-assured', name: 'spring-mock-mvc', version: "$restAssuredVersion"
    compile "io.rest-assured:rest-assured:$restAssuredVersion"
    compile "io.rest-assured:json-path:$restAssuredVersion"
    compile "io.rest-assured:xml-path:$restAssuredVersion"
    compile "io.rest-assured:json-schema-validator:$restAssuredVersion"
    compile 'org.spockframework:spock-core:1.1-groovy-2.4-SNAPSHOT'
    compile 'com.electriccloud:ec-specs-plugins-core:1.1'
    compile 'de.gesellix:docker-client:2018-01-26T21-28-05'
}




task wrapper(type: Wrapper) {
    gradleVersion = '4.8'
}


clean.doFirst {
    delete "src/main/resources/logs/allureLog.log"
    delete "${rootDir}/out"
    delete "${rootDir}/build"
    delete "${rootDir}/scr/commander/resources/config/history"
    delete "${rootDir}/allure-results"
    delete "${rootDir}/allure-report"
    delete "${rootDir}/.ecsession"
}


import io.qameta.allure.gradle.task.AllureReport
task allureAggregatedReport(type: AllureReport) {
    allure.resultsDir
    // Task: ./gradlew allureServe  - to watch the rgenerated report
}



task allureConfiguration(type: Copy){
    def configDir = "${rootDir}/specs/src/commander/resources/config/allure"
    from "${configDir}/categories.json", "${configDir}/environment.properties", "${configDir}/executor.json"
    into "${rootDir}/build/allure-results"
}



task systemTest(type: Test){

    systemProperty "file.encoding", "utf-8"
    systemProperty "log4j.configuration", "file:///${rootDir.absolutePath}/src/main/resources/log4j.properties"
    systemProperty "allure.link.issue.pattern", "http://jira.electric-cloud.com/browse/{}"
    systemProperty "allure.link.tms.pattern", "https://ecflow.testrail.net/index.php?/cases/view/{}"
    ignoreFailures = true
    useTestNG() {
        suites "${suiteDir}/sanityTests.xml"
    }
    testLogging.showStandardStreams = true

    def destination = findProperty('reportDestination') ?: "${rootDir}/build/reports/allure-report"
    if (destination) {
        reports {
            html.destination = "$destination"
        }
    }

}
systemTest.finalizedBy allureAggregatedReport





test {
    systemProperties["COMMANDER_SECURE"] = '1'
    def server = findProperty('commanderServer') ?: findProperty('COMMANDER_SERVER') ?: 'localhost'
    systemProperties['COMMANDER_SERVER'] = server

    testLogging {
        showStandardStreams = true
        exceptionFormat = 'full'
    }
    outputs.upToDateWhen { false }
    systemProperties['EC_SPECS_CLI'] = true

    def destination = findProperty('reportDestination') ?: "spec-report"
    if (destination) {
        reports {
            html.destination = destination
        }
    }
}
